#!/bin/bash

# FoodFlow CLI - Script de orquestación del proyecto
# Uso: ./ff <comando> [argumentos]

set -e

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$PROJECT_ROOT"

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Comando: up
# Levanta la base de datos y el backend
cmd_up() {
    log_info "Levantando servicios de FoodFlow..."
    
    # Levantar PostgreSQL en Docker
    log_info "Iniciando PostgreSQL en Docker..."
    docker compose up -d
    
    # Esperar a que PostgreSQL esté listo
    log_info "Esperando a que PostgreSQL esté listo..."
    sleep 3
    
    # Levantar backend
    log_info "Iniciando backend Spring Boot..."
    ./mvnw spring-boot:run
}

# Comando: down
# Baja todos los servicios
cmd_down() {
    log_info "Bajando servicios de FoodFlow..."
    
    # Bajar Docker Compose
    docker compose down
    
    log_info "Servicios detenidos"
}

# Comando: restart
# Reinicia servicios
cmd_restart() {
    local service="$1"
    
    if [ -z "$service" ]; then
        log_info "Reiniciando todos los servicios..."
        cmd_down
        cmd_up
    else
        log_info "Reiniciando servicio: $service"
        docker compose restart "$service"
    fi
}

# Comando: test
# Ejecuta tests
cmd_test() {
    local test_name="$1"
    
    if [ -z "$test_name" ]; then
        log_info "Ejecutando todos los tests..."
        ./mvnw test
    else
        log_info "Ejecutando test: $test_name"
        ./mvnw test -Dtest="$test_name"
    fi
}

# Comando: staging
# Ejecuta scripts SQL de staging
cmd_staging() {
    local sql_file="$1"
    
    if [ -z "$sql_file" ]; then
        log_error "Debe especificar un archivo SQL"
        log_info "Uso: ./ff staging <archivo.sql>"
        exit 1
    fi
    
    if [ ! -f "$sql_file" ]; then
        log_error "Archivo no encontrado: $sql_file"
        exit 1
    fi
    
    log_info "Ejecutando script SQL: $sql_file"
    
    # Ejecutar SQL contra el contenedor de PostgreSQL
    docker compose exec -T db psql -U foodflow_user -d foodflow_db -f - < "$sql_file"
    
    log_info "Script ejecutado exitosamente"
}

# Comando: logs
# Muestra logs de los servicios
cmd_logs() {
    local service="$1"
    
    if [ -z "$service" ]; then
        docker compose logs -f
    else
        docker compose logs -f "$service"
    fi
}

# Comando: db
# Acceso directo a psql
cmd_db() {
    log_info "Conectando a PostgreSQL..."
    docker compose exec db psql -U foodflow_user -d foodflow_db
}

# Comando: clean
# Limpia build artifacts
cmd_clean() {
    log_info "Limpiando build artifacts..."
    ./mvnw clean
    log_info "Limpieza completada"
}

# Mostrar ayuda
show_help() {
    cat << EOF
FoodFlow CLI - Herramienta de desarrollo

Uso: ./ff <comando> [argumentos]

Comandos disponibles:

  up                          Levanta PostgreSQL (Docker) y backend
  down                        Baja todos los servicios
  restart [servicio]          Reinicia todos los servicios o uno específico
  test [nombre]               Ejecuta todos los tests o uno específico
  staging <script.sql>        Ejecuta un script SQL de staging
  logs [servicio]             Muestra logs de los servicios
  db                          Abre una consola psql en el contenedor
  clean                       Limpia build artifacts de Maven

Ejemplos:

  ./ff up
  ./ff test
  ./ff test ConsultarMesasUseCaseTest
  ./ff staging scripts/seed-data.sql
  ./ff restart
  ./ff restart db
  ./ff logs db
  ./ff down

EOF
}

# Router principal
case "${1:-}" in
    up)
        cmd_up
        ;;
    down)
        cmd_down
        ;;
    restart)
        cmd_restart "$2"
        ;;
    test)
        cmd_test "$2"
        ;;
    staging)
        cmd_staging "$2"
        ;;
    logs)
        cmd_logs "$2"
        ;;
    db)
        cmd_db
        ;;
    clean)
        cmd_clean
        ;;
    help|--help|-h)
        show_help
        ;;
    "")
        log_error "Debe especificar un comando"
        show_help
        exit 1
        ;;
    *)
        log_error "Comando desconocido: $1"
        show_help
        exit 1
        ;;
esac
