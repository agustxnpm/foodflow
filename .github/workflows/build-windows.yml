name: Build Windows Installer

on:
  workflow_dispatch:  # Ejecutar manualmente desde GitHub
  push:
    tags:
      - 'v*'  # También al crear un tag de versión

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      # 1. Checkout del código
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Setup Java 21 para compilar el backend
      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      # 3. Compilar backend Spring Boot
      - name: Build backend
        working-directory: comandas-backend
        run: ./mvnw.cmd clean package -DskipTests

      # 4. Copiar JAR a binarios de Tauri
      - name: Copy backend JAR to Tauri binaries
        run: |
          copy comandas-backend\target\comandas-backend-0.0.1-SNAPSHOT.jar comandas-frontend\src-tauri\binaries\backend.jar

      # 5. Generar JRE completo con jlink (embebido en el instalador)
      #    Incluye TODOS los módulos para máxima compatibilidad
      - name: Create embedded JRE with jlink
        shell: pwsh
        run: |
          $JAVA_HOME_PATH = $env:JAVA_HOME
          Write-Host "JAVA_HOME: $JAVA_HOME_PATH"
          
          $jreDest = "comandas-frontend\src-tauri\jre"
          
          # Limpiar directorio si existe
          if (Test-Path $jreDest) { Remove-Item -Recurse -Force $jreDest }
          
          # Incluir TODOS los módulos — compatibilidad sobre tamaño
          & "$JAVA_HOME_PATH\bin\jlink" `
            --add-modules ALL-MODULE-PATH `
            --no-man-pages `
            --no-header-files `
            --output $jreDest
          
          # Verificar que se creó correctamente
          & "$jreDest\bin\java.exe" -version
          
          # Mostrar tamaño del JRE
          $size = (Get-ChildItem -Recurse $jreDest | Measure-Object -Property Length -Sum).Sum / 1MB
          Write-Host "Tamaño del JRE embebido: $([math]::Round($size, 2)) MB"

      # 6. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: comandas-frontend/package-lock.json

      # 7. Instalar dependencias del frontend
      - name: Install frontend dependencies
        working-directory: comandas-frontend
        run: npm ci

      # 8. Setup Rust (necesario para Tauri)
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      # 9. Cache de compilación Rust
      - name: Cache Rust build
        uses: actions/cache@v4
        with:
          path: |
            comandas-frontend/src-tauri/target
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-${{ hashFiles('comandas-frontend/src-tauri/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      # 10. Construir Tauri para Windows
      - name: Build Tauri app
        working-directory: comandas-frontend
        run: npm run tauri:build

      # 11. Subir instalador NSIS (.exe)
      - name: Upload NSIS installer
        uses: actions/upload-artifact@v4
        with:
          name: FoodFlow-Windows-NSIS
          path: comandas-frontend/src-tauri/target/release/bundle/nsis/*.exe
          retention-days: 30

      # 12. Subir instalador MSI
      - name: Upload MSI installer
        uses: actions/upload-artifact@v4
        with:
          name: FoodFlow-Windows-MSI
          path: comandas-frontend/src-tauri/target/release/bundle/msi/*.msi
          retention-days: 30
